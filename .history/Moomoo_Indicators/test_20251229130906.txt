N:102,1,200;
M:7,1,50;

{------------------------------------
  1. 典型价格 & 长期通道基线
------------------------------------}
TYPICAL_PRICE := (2*CLOSE + HIGH + LOW) / 4;
AA := MA(TYPICAL_PRICE, 5);

{------------------------------------
  2. 长期通道（外侧）
------------------------------------}
CHANNEL1 := AA * N / 100;
CHANNEL2 := AA * (200 - N) / 100;

{------------------------------------
  3. 短期通道波动率
------------------------------------}
MA20_CLOSE := MA(CLOSE, 20);
CC := ABS(TYPICAL_PRICE - MA20_CLOSE) / MA20_CLOSE;

{------------------------------------
  4. 动态移动平均 DD（关键修正）
------------------------------------}
DD := IF(        ISNULL(REF(DD,1)),        CLOSE,                                  { 第一根K线初始化 }        CC * CLOSE + (1 - CC) * REF(DD,1)       { 递推公式 }
      );

{------------------------------------
  5. 短期通道（内侧）
------------------------------------}
CHANNEL3 := DD * (1 + M / 100);
CHANNEL4 := DD * (1 - M / 100);

{------------------------------------
  6. 输出
------------------------------------}
CHANNEL1:CHANNEL1,COLOR808080,LINETHICK2;
CHANNEL2:CHANNEL2,COLOR00FF00,LINETHICK2;
CHANNEL3:CHANNEL3,COLORFF0000,LINETHICK1;
CHANNEL4:CHANNEL4,COLOR0000FF,LINETHICK1;
